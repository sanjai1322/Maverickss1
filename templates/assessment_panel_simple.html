{% extends "base.html" %}

{% block title %}Assessment Panel - Mavericks{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="maverick-heading">
                    <i class="fas fa-code me-2"></i>
                    Assessment Panel
                </h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateExerciseModal">
                    <i class="fas fa-magic me-1"></i>
                    Generate Exercise
                </button>
            </div>
        </div>
    </div>

    <!-- Exercise Generation Results -->
    <div class="row" id="exercisesContainer">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Generated Exercises
                    </h5>
                </div>
                <div class="card-body">
                    <div id="exercisesList" class="row">
                        <div class="col-12 text-center text-muted py-4">
                            <i class="fas fa-code fa-3x mb-3 opacity-50"></i>
                            <p>No exercises generated yet. Click "Generate Exercise" to create coding challenges.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessages" class="mt-3"></div>
</div>

<!-- Generate Exercise Modal -->
<div class="modal fade" id="generateExerciseModal" tabindex="-1" aria-labelledby="generateExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateExerciseModalLabel">
                    <i class="fas fa-magic me-2"></i>
                    Generate AI Coding Exercise
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generateExerciseForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="skill" class="form-label">Programming Language</label>
                            <select class="form-select" id="skill" name="skill" required>
                                <option value="">Select Language</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="csharp">C#</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="difficulty" class="form-label">Difficulty Level</label>
                            <select class="form-select" id="difficulty" name="difficulty" required>
                                <option value="">Select Difficulty</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                                <option value="expert">Expert</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="topic" class="form-label">Topic/Concept (Optional)</label>
                        <input type="text" class="form-control" id="topic" name="topic" placeholder="e.g., Arrays, Algorithms, Data Structures">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generateBtn">
                    <i class="fas fa-magic me-1"></i>
                    Generate Exercise
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('generateExerciseForm');
    const generateBtn = document.getElementById('generateBtn');
    const modal = new bootstrap.Modal(document.getElementById('generateExerciseModal'));

    generateBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        const skill = formData.get('skill');
        const difficulty = formData.get('difficulty');
        
        if (!skill || !difficulty) {
            showMessage('Please select both programming language and difficulty level.', 'warning');
            return;
        }

        // Show loading state
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';

        // Make API request
        fetch('/generate_exercise', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addExerciseToList(data.exercise);
                form.reset();
                modal.hide();
                showMessage('Exercise generated successfully!', 'success');
            } else {
                showMessage('Error: ' + (data.error || 'Failed to generate exercise'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error generating exercise. Please try again.', 'danger');
        })
        .finally(() => {
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
        });
    });

    function addExerciseToList(exercise) {
        const exercisesList = document.getElementById('exercisesList');
        
        // Clear empty state if present
        if (exercisesList.querySelector('.text-muted')) {
            exercisesList.innerHTML = '';
        }

        const exerciseCard = document.createElement('div');
        exerciseCard.className = 'col-lg-6 mb-4';
        exerciseCard.innerHTML = `
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${exercise.title}</h6>
                        <span class="badge bg-light text-dark">${exercise.difficulty}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">${exercise.description}</p>
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-code me-1"></i>${exercise.skill}
                            <i class="fas fa-clock me-1 ms-3"></i>${exercise.estimated_time}
                            <i class="fas fa-star me-1 ms-3"></i>${exercise.points} points
                        </small>
                    </div>
                    <div class="mb-3">
                        <strong>Starter Code:</strong>
                        <pre class="bg-dark text-light p-2 rounded mt-1" style="font-size: 0.85em; white-space: pre-wrap;">${exercise.starter_code}</pre>
                    </div>
                    <div class="mb-3">
                        <strong>Test Cases:</strong>
                        <ul class="list-unstyled mt-1">
                            ${exercise.test_cases.map(test => `<li class="small text-muted">â€¢ ${test}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="startExercise('${exercise.title}')">
                            <i class="fas fa-play"></i> Start Now
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="copyCode('${exercise.starter_code.replace(/'/g, "\\'")}')">
                            <i class="fas fa-copy"></i> Copy Code
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        exercisesList.appendChild(exerciseCard);
    }

    function showMessage(message, type) {
        const statusMessages = document.getElementById('statusMessages');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        statusMessages.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
});

function startExercise(title) {
    alert(`Starting exercise: ${title}\n\nThis would typically open a coding environment where you can solve the challenge.`);
}

function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert('Starter code copied to clipboard!');
    }).catch(() => {
        alert('Failed to copy code. Please copy manually.');
    });
}
</script>
{% endblock %}